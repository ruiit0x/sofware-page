<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å«å£«åƒä»£ç  - Defender Eats Code</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b1a2e; /* é»‘æš—ã€ç§‘æŠ€æ„Ÿçš„ä¸»é¢˜ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            overflow: hidden; /* å…³é”®ï¼šé˜²æ­¢é¡µé¢æ»šåŠ¨ï¼ˆåæ»šåŠ¨ï¼‰ */
        }

        /* æ¸¸æˆæ¿æ ·å¼ */
        #gameCanvas {
            border: 4px solid #00c6ff; /* éœ“è™¹è“è¾¹æ¡† */
            box-shadow: 0 0 20px rgba(0, 198, 255, 0.5);
            background-color: #000;
            border-radius: 8px;
            display: block;
            touch-action: none; /* ç¦ç”¨é»˜è®¤è§¦æ‘¸è¡Œä¸º */
        }

        /* æ¸¸æˆUIå®¹å™¨ */
        .game-ui {
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
        }

        /* è§¦æ‘¸æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .control-button {
            transition: transform 0.1s ease;
            box-shadow: 0 4px 0 #4a4a4a;
        }
        .control-button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #4a4a4a;
        }
        
        /* å¼ºåˆ¶ç”»å¸ƒè‡ªé€‚åº”å®¹å™¨å®½åº¦ */
        .canvas-container {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>

<div class="game-ui flex flex-col items-center gap-4">
    <h1 class="text-3xl font-extrabold text-white text-center tracking-wider" style="text-shadow: 0 0 8px #00c6ff;">
        ã€Šå«å£«åƒä»£ç ã€‹
    </h1>

    <!-- çŠ¶æ€é¢æ¿ -->
    <div class="w-full bg-[#1e293b] p-3 rounded-lg shadow-xl flex justify-around text-lg font-bold text-white border-b-2 border-indigo-400">
        <div>å¾—åˆ†: <span id="scoreDisplay" class="text-yellow-300">0</span></div>
        <div>ç”Ÿå‘½: <span id="livesDisplay" class="text-red-400">3</span></div>
        <button id="startButton" class="px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-150 text-sm">å¼€å§‹æ¸¸æˆ</button>
    </div>

    <!-- æ¸¸æˆç”»å¸ƒå®¹å™¨ -->
    <div class="canvas-container">
        <canvas id="gameCanvas"></canvas>
    </div>

    <!-- æ¸¸æˆä¿¡æ¯å’Œè§¦æ‘¸æ§åˆ¶ -->
    <div class="w-full max-w-sm flex flex-col items-center gap-3">
        <!-- è§¦æ‘¸æ§åˆ¶ (ä¸ºç§»åŠ¨è®¾å¤‡ä¼˜åŒ–) -->
        <div id="touchControls" class="grid grid-cols-3 gap-2 p-2 rounded-lg bg-[#1e293b] w-48 hidden">
            <button id="upBtn" class="control-button col-start-2 bg-gray-600 text-white p-3 rounded-lg">â¬†</button>
            <div class="col-start-1 flex justify-between col-span-3">
                <button id="leftBtn" class="control-button bg-gray-600 text-white p-3 rounded-lg">â¬…</button>
                <div></div>
                <button id="rightBtn" class="control-button bg-gray-600 text-white p-3 rounded-lg">â¡</button>
            </div>
            <button id="downBtn" class="control-button col-start-2 bg-gray-600 text-white p-3 rounded-lg">â¬‡</button>
        </div>
        
        <!-- æ¶ˆæ¯åŒº -->
        <div id="messageBox" class="text-center text-yellow-400 font-semibold p-2 bg-gray-800 rounded-lg w-full">
            ç‚¹å‡»â€œå¼€å§‹æ¸¸æˆâ€æˆ–æŒ‰ä»»æ„æ–¹å‘é”®å¼€å§‹ï¼
        </div>
    </div>
</div>

<script>
    // ==========================================================
    // é…ç½®ä¸åˆå§‹åŒ–
    // ==========================================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // --- ã€è‡ªå®šä¹‰å›¾ç‰‡é…ç½®åŒºåŸŸã€‘ ---
    // !!! è¯·å°†ä»¥ä¸‹ URL æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ PNG å›¾ç‰‡é“¾æ¥ !!!
    // å«å£« (ç©å®¶) å›¾ç‰‡ URL
    const DEFENDER_IMAGE_URL = "https://s2-techtudo.glbimg.com/I0rMUY1YHBF7l58pLcMPjU1Wmh4=/400x0/smart/filters:strip_icc()/s.glbimg.com/po/tt2/f/original/2018/06/14/windows-defender-icone.jpg"; 
    // æ¶æ„è½¯ä»¶ (å¹½çµ) å›¾ç‰‡ URL
    const MALWARE_IMAGE_URL = "https://ik.imagekit.io/qualys/wp-content/uploads/2017/05/red-lock.jpg";
    
    let defenderImage = new Image();
    defenderImage.src = DEFENDER_IMAGE_URL;

    let malwareImage = new Image();
    malwareImage.src = MALWARE_IMAGE_URL;

    // åœ°å›¾å®šä¹‰ (1: å¢™, 0: è·¯å¾„/ä»£ç , 2: ç©ºè·¯å¾„, 3: é˜²ç«å¢™å‡çº§)
    const INITIAL_MAP_LAYOUT = [
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        [1, 3, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 3, 1],
        [1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1],
        [1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1],
        [1, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1],
        [1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1],
        [1, 1, 1, 1, 0, 1, 1, 0, 2, 2, 2, 0, 0, 1, 1, 0, 1, 1, 1, 1],
        [1, 1, 1, 1, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 0, 1, 1, 1, 1],
        [1, 1, 1, 1, 0, 1, 1, 0, 2, 2, 2, 2, 0, 1, 1, 0, 1, 1, 1, 1],
        [1, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1],
        [1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1],
        [1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1],
        [1, 3, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 3, 1],
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
    ];
    let MAP = []; // è¿è¡Œæ—¶åœ°å›¾
    
    // æ¸¸æˆå…ƒç´ å¤§å°å’Œé€Ÿåº¦
    let TILE_SIZE = 30; // ç“¦ç‰‡å°ºå¯¸ (åƒç´ )
    const PLAYER_SPEED = 3.2; // ç©å®¶ç§»åŠ¨é€Ÿåº¦ (å¢åŠ ä»¥å‡å°‘å¡é¡¿)
    const GHOST_SPEED = 2.5; // å¹½çµç§»åŠ¨é€Ÿåº¦ (åƒç´ /å¸§)

    const MAP_H = INITIAL_MAP_LAYOUT.length;
    const MAP_W = INITIAL_MAP_LAYOUT[0].length;
    
    // æ¸¸æˆçŠ¶æ€
    let score = 0;
    let lives = 3;
    let gameActive = false;
    let lastTime = 0;
    let totalDots = 0;
    let dotsEaten = 0;
    
    // é˜²ç«å¢™çŠ¶æ€
    let firewallActive = false;
    let firewallTimer = 0;
    const FIREWALL_DURATION = 8000; // 8ç§’

    // å®ä½“å¯¹è±¡
    const player = {
        x: 0, y: 0,
        radius: TILE_SIZE * 0.48, // å¢åŠ åŠå¾„ï¼Œè§£å†³å¤ªå°å¡ä½çš„é—®é¢˜
        dirX: 0, dirY: 0,
        targetDirX: 0, targetDirY: 0,
        startCol: 1, startRow: 1
    };

    const ghosts = [
        createGhost(9, 8, 'rgb(255, 0, 0)', 'Malware Red'),
        createGhost(10, 8, 'rgb(255, 128, 0)', 'Malware Orange'),
        createGhost(9, 9, 'rgb(0, 255, 255)', 'Malware Cyan'),
    ];

    // ==========================================================
    // è¾…åŠ©å‡½æ•°
    // ==========================================================

    /**
     * åˆ›å»ºå¹½çµå¯¹è±¡
     */
    function createGhost(startCol, startRow, color, name) {
        return {
            x: 0, y: 0,
            size: TILE_SIZE * 0.8,
            color: color,
            name: name,
            dirX: 0, dirY: 0,
            isFrightened: false,
            isDead: false,
            homeX: startCol,
            homeY: startRow,
        };
    }
    
    /**
     * è·å–ç“¦ç‰‡ä¸­å¿ƒç‚¹çš„åƒç´ åæ ‡
     */
    function getTileCenter(col, row) {
        return {
            x: col * TILE_SIZE + TILE_SIZE / 2,
            y: row * TILE_SIZE + TILE_SIZE / 2
        };
    }

    /**
     * æ£€æŸ¥ç»™å®šåæ ‡æ˜¯å¦ä¸å¢™ä½“ç¢°æ’
     */
    function checkWallCollision(x, y, radius) {
        // å¢åŠ ç¢°æ’æ£€æµ‹çš„é‡‡æ ·ç‚¹ï¼Œé˜²æ­¢è§’è‰²è¾¹ç¼˜è§¦å¢™
        const collisionMargin = radius * 0.95; 

        const checkPoints = [
            { dx: collisionMargin, dy: 0 },
            { dx: -collisionMargin, dy: 0 },
            { dx: 0, dy: collisionMargin },
            { dx: 0, dy: -collisionMargin }
        ];

        for (const { dx, dy } of checkPoints) {
            const tileX = Math.floor((x + dx) / TILE_SIZE);
            const tileY = Math.floor((y + dy) / TILE_SIZE);
            if (tileX >= 0 && tileX < MAP_W && tileY >= 0 && tileY < MAP_H) {
                // ç¡®ä¿æ£€æŸ¥ç‚¹è½åœ¨å¢™ä¸Š
                if (MAP[tileY][tileX] === 1) {
                    return true;
                }
            } else {
                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºåœ°å›¾è¾¹ç•Œ
                return true;
            }
        }
        return false;
    }
    
    /**
     * é‡ç½®ç©å®¶å’Œå¹½çµçš„ä½ç½®
     */
    function resetPositions() {
        const pPos = getTileCenter(player.startCol, player.startRow);
        player.x = pPos.x;
        player.y = pPos.y;
        player.dirX = 0;
        player.dirY = 0;
        player.targetDirX = 0;
        player.targetDirY = 0;

        ghosts.forEach(ghost => {
            const gPos = getTileCenter(ghost.homeX, ghost.homeY);
            ghost.x = gPos.x;
            ghost.y = gPos.y;
            ghost.dirX = 0;
            ghost.dirY = 0;
            ghost.isFrightened = false;
            ghost.isDead = false;
        });
    }

    // ==========================================================
    // æ¸²æŸ“å‡½æ•°
    // ==========================================================

    /**
     * ç»˜åˆ¶è¿·å®«å’Œæ‰€æœ‰é™æ€å…ƒç´ 
     */
    function drawMap() {
        for (let r = 0; r < MAP_H; r++) {
            for (let c = 0; c < MAP_W; c++) {
                const x = c * TILE_SIZE;
                const y = r * TILE_SIZE;

                // ç»˜åˆ¶å¢™
                if (MAP[r][c] === 1) {
                    ctx.fillStyle = '#004d99';
                    ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                    ctx.strokeStyle = '#00c6ff';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);
                }

                // ç»˜åˆ¶æ¸…æ´ä»£ç  (åœ†ç‚¹)
                else if (MAP[r][c] === 0) {
                    ctx.fillStyle = '#ffe600';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, TILE_SIZE * 0.15, 0, Math.PI * 2);
                    ctx.fill();
                }

                // ç»˜åˆ¶é˜²ç«å¢™å‡çº§ (å¤§åŠ›ä¸¸)
                else if (MAP[r][c] === 3) {
                    ctx.fillStyle = '#ff004c';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, TILE_SIZE * 0.3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }
    }

    /**
     * ç»˜åˆ¶å«å£« (ç©å®¶) - ä½¿ç”¨ PNG å›¾ç‰‡
     */
    function drawPlayer() {
        const size = player.radius * 2;
        // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥æˆ–æœªåŠ è½½ï¼Œåˆ™ä½¿ç”¨é»„è‰²åœ†åœˆä½œä¸ºå¤‡ç”¨
        if (defenderImage.complete && defenderImage.naturalHeight !== 0) {
            ctx.drawImage(defenderImage, player.x - size / 2, player.y - size / 2, size, size);
        } else {
            // ç»˜åˆ¶å¤‡ç”¨é»„è‰²åœ†åœˆ
            ctx.fillStyle = '#ffe600';
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fill();
            // ç»˜åˆ¶å¤‡ç”¨å›¾æ ‡
            ctx.fillStyle = 'black';
            ctx.font = `${player.radius}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ğŸ›¡ï¸', player.x, player.y);
        }
    }

    /**
     * ç»˜åˆ¶æ¶æ„è½¯ä»¶ (å¹½çµ) - ä½¿ç”¨ PNG å›¾ç‰‡
     */
    function drawGhosts() {
        ghosts.forEach(ghost => {
            const size = ghost.size;
            
            if (ghost.isDead) {
                // å¦‚æœè¢«åƒæ‰ï¼Œåªæ˜¾ç¤ºçµé­‚
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.font = `${size * 0.7}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ğŸ‘»', ghost.x, ghost.y + 2);
                return;
            }

            // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥æˆ–æœªåŠ è½½ï¼Œåˆ™ä½¿ç”¨å½©è‰²å½¢çŠ¶ä½œä¸ºå¤‡ç”¨
            if (malwareImage.complete && malwareImage.naturalHeight !== 0) {
                // ç»˜åˆ¶å›¾ç‰‡
                ctx.drawImage(malwareImage, ghost.x - size / 2, ghost.y - size / 2, size, size);
            } else {
                // ç»˜åˆ¶å¤‡ç”¨å¹½çµå½¢çŠ¶
                ctx.fillStyle = ghost.color;
                ctx.fillRect(ghost.x - size/2, ghost.y - size/2, size, size);
            }
            
            // å—æƒŠæ—¶çš„ç‰¹æ•ˆ (å åŠ æ•ˆæœ)
            if (ghost.isFrightened) {
                 ctx.fillStyle = 'rgba(0, 0, 255, 0.5)'; // è“è‰²åŠé€æ˜è¦†ç›–
                 ctx.fillRect(ghost.x - size/2, ghost.y - size/2, size, size);
                 
                 // è­¦å‘Šå›¾æ ‡
                 ctx.fillStyle = 'white';
                 ctx.font = `${size * 0.5}px Arial`;
                 ctx.textAlign = 'center';
                 ctx.textBaseline = 'middle';
                 ctx.fillText('âš¡', ghost.x, ghost.y + size * 0.3);
            }
        });
    }

    // ==========================================================
    // æ¸¸æˆé€»è¾‘
    // ==========================================================

    /**
     * å¹½çµ AI å†³ç­– (åœ¨ç“¦ç‰‡ä¸­å¿ƒç‚¹æ‰§è¡Œ)
     */
    function ghostAI(ghost, c, r) {
        let possibleDirections = [];
        const directions = [{ dx: 1, dy: 0 }, { dx: -1, dy: 0 }, { dx: 0, dy: 1 }, { dx: 0, dy: -1 }];

        for (const { dx, dy } of directions) {
            const nextC = c + dx;
            const nextR = r + dy;
            
            if (nextC >= 0 && nextC < MAP_W && nextR >= 0 && nextR < MAP_H && MAP[nextR][nextC] !== 1) {
                if (dx !== -ghost.dirX || dy !== -ghost.dirY || ghost.isFrightened) {
                    possibleDirections.push({ dx, dy });
                }
            }
        }
        
        if (possibleDirections.length === 0) {
            // è¢«å›°ä½äº†ï¼Œåªèƒ½æ‰å¤´
            return { dx: -ghost.dirX, dy: -ghost.dirY };
        }
        
        let nextDir = possibleDirections[0];
        let bestScore = -Infinity; // è¿½é€æ¨¡å¼ï¼šæœ€å¤§åŒ–å¾—åˆ† (æœ€å°åŒ–è·ç¦»ä¸ºç›®æ ‡)
        if (ghost.isFrightened) bestScore = Infinity; // é€ƒè·‘æ¨¡å¼ï¼šæœ€å°åŒ–å¾—åˆ† (æœ€å¤§åŒ–è·ç¦»)

        // è¿½é€/é€ƒè·‘å†³ç­–
        possibleDirections.forEach(dir => {
            const nextTile = getTileCenter(c + dir.dx, r + dir.dy);
            const distSq = (player.x - nextTile.x) ** 2 + (player.y - nextTile.y) ** 2;

            let score = -distSq; 
            if (ghost.isFrightened) score = distSq;
            
            if ((ghost.isFrightened && score > bestScore) || (!ghost.isFrightened && score > bestScore)) {
                bestScore = score;
                nextDir = dir;
            }
        });
        
        return nextDir;
    }


    /**
     * æ¶æ„è½¯ä»¶ç§»åŠ¨é€»è¾‘
     */
    function moveGhosts() {
        ghosts.forEach(ghost => {
            const speed = ghost.isFrightened ? GHOST_SPEED * 0.7 : GHOST_SPEED; // å—æƒŠå‡é€Ÿ
            
            if (ghost.isDead) {
                // è¢«åƒæ‰çš„å¹½çµåŠ é€Ÿè¿”å›å¹½çµå±‹
                const targetPos = getTileCenter(ghost.homeX, ghost.homeY);
                const dx = targetPos.x - ghost.x;
                const dy = targetPos.y - ghost.y;
                const distSq = dx * dx + dy * dy;

                if (distSq < 4) { // æ¥è¿‘ä¸­å¿ƒæ—¶é‡ç”Ÿ
                    ghost.isDead = false;
                    ghost.isFrightened = false;
                    ghost.x = targetPos.x;
                    ghost.y = targetPos.y;
                    return;
                }
                
                const dist = Math.sqrt(distSq);
                // å¹½çµåŠ é€Ÿè¿”å›
                ghost.x += (dx / dist) * GHOST_SPEED * 2; 
                ghost.y += (dy / dist) * GHOST_SPEED * 2;
                return;
            }
            
            const c = Math.floor(ghost.x / TILE_SIZE);
            const r = Math.floor(ghost.y / TILE_SIZE);
            const centerPos = getTileCenter(c, r);

            const atCenter = Math.abs(ghost.x - centerPos.x) < speed && Math.abs(ghost.y - centerPos.y) < speed;

            if (atCenter) {
                ghost.x = centerPos.x;
                ghost.y = centerPos.y;

                const nextDir = ghostAI(ghost, c, r);
                ghost.dirX = nextDir.dx;
                ghost.dirY = nextDir.dy;
            }

            // ç§»åŠ¨
            ghost.x += ghost.dirX * speed;
            ghost.y += ghost.dirY * speed;
        });
    }


    /**
     * ç©å®¶ç§»åŠ¨å’Œç¢°æ’å¤„ç†
     */
    function movePlayer() {
        // 1. å°è¯•åˆ‡æ¢æ–¹å‘ (è§£å†³å¡é¡¿çš„å…³é”®ï¼šè§’è½è½¬å‘å’Œä¸­å¿ƒå¸é™„)
        if (player.targetDirX !== 0 || player.targetDirY !== 0) {
            const newX = player.x + player.targetDirX * PLAYER_SPEED;
            const newY = player.y + player.targetDirY * PLAYER_SPEED;
            
            if (!checkWallCollision(newX, newY, player.radius)) {
                
                // *** ç“¦ç‰‡ä¸­å¿ƒå¸é™„é€»è¾‘ (å‡å°‘å¡é¡¿) ***
                const currentC = Math.floor(player.x / TILE_SIZE);
                const currentR = Math.floor(player.y / TILE_SIZE);
                const centerPos = getTileCenter(currentC, currentR);
                
                // å¦‚æœæ˜¯æ°´å¹³æ–¹å‘ç§»åŠ¨ï¼Œåˆ™å°† Y è½´å¯¹é½åˆ°ä¸­å¿ƒ
                if (player.targetDirX !== 0) { 
                    player.y = centerPos.y;
                } 
                // å¦‚æœæ˜¯å‚ç›´æ–¹å‘ç§»åŠ¨ï¼Œåˆ™å°† X è½´å¯¹é½åˆ°ä¸­å¿ƒ
                else if (player.targetDirY !== 0) { 
                    player.x = centerPos.x;
                }
                
                player.dirX = player.targetDirX;
                player.dirY = player.targetDirY;
                player.targetDirX = 0;
                player.targetDirY = 0;
            }
        }

        // 2. å®é™…ç§»åŠ¨
        const nextX = player.x + player.dirX * PLAYER_SPEED;
        const nextY = player.y + player.dirY * PLAYER_SPEED;

        if (!checkWallCollision(nextX, nextY, player.radius)) {
            player.x = nextX;
            player.y = nextY;
        } else {
            // æ’å¢™æ—¶åœæ­¢
            player.dirX = 0;
            player.dirY = 0;
        }
    }
    
    // ... (checkDotCollision, activateFirewall, checkGhostCollision, gameLoop, updateScore, updateLives ä¿æŒä¸å˜)
    
    /**
     * æ£€æŸ¥å«å£«æ˜¯å¦åƒåˆ°äº†æ¸…æ´ä»£ç æˆ–é˜²ç«å¢™å‡çº§
     */
    function checkDotCollision() {
        const c = Math.floor(player.x / TILE_SIZE);
        const r = Math.floor(player.y / TILE_SIZE);

        if (c < 0 || c >= MAP_W || r < 0 || r >= MAP_H) return;

        // 1. åƒåˆ°æ¸…æ´ä»£ç  (0)
        if (MAP[r][c] === 0) {
            MAP[r][c] = 2; // æ ‡è®°ä¸ºå·²åƒ
            score += 10;
            dotsEaten++;
        }
        // 2. åƒåˆ°é˜²ç«å¢™å‡çº§ (3)
        else if (MAP[r][c] === 3) {
            MAP[r][c] = 2; // æ ‡è®°ä¸ºå·²åƒ
            score += 50;
            activateFirewall();
        }

        // æ£€æŸ¥æ˜¯å¦èƒœåˆ©
        if (dotsEaten >= totalDots) {
            gameOver(true);
        }
        
        updateScore();
    }

    /**
     * æ¿€æ´»é˜²ç«å¢™å‡çº§çŠ¶æ€
     */
    function activateFirewall() {
        firewallActive = true;
        firewallTimer = FIREWALL_DURATION;
        document.getElementById('messageBox').textContent = 'âš ï¸ é˜²ç«å¢™å‡çº§å·²æ¿€æ´»ï¼ç°åœ¨å¯ä»¥æ¸…ç†æ¶æ„è½¯ä»¶ï¼ (8ç§’)';
        
        ghosts.forEach(ghost => {
            if (!ghost.isDead) {
                ghost.isFrightened = true;
                // å¹½çµæ‰å¤´
                ghost.dirX = -ghost.dirX;
                ghost.dirY = -ghost.dirY;
            }
        });
    }

    /**
     * æ£€æŸ¥ç©å®¶æ˜¯å¦ä¸æ¶æ„è½¯ä»¶ç¢°æ’
     */
    function checkGhostCollision() {
        ghosts.forEach(ghost => {
            if (ghost.isDead) return;

            const dist = Math.sqrt(
                (player.x - ghost.x) ** 2 + (player.y - ghost.y) ** 2
            );

            // ç¢°æ’è·ç¦»è®¡ç®—
            if (dist < player.radius + ghost.size * 0.4) {
                // å‘ç”Ÿç¢°æ’ï¼
                if (firewallActive && ghost.isFrightened) {
                    // å«å£«èƒœåˆ©ï¼šåƒæ‰æ¶æ„è½¯ä»¶
                    ghost.isDead = true;
                    score += 200;
                    document.getElementById('messageBox').textContent = `ğŸ‰ æ¸…ç†äº†æ¶æ„è½¯ä»¶: ${ghost.name}! +200åˆ†`;
                } else {
                    // å«å£«å¤±è´¥ï¼šè¢«æ¶æ„è½¯ä»¶æ„ŸæŸ“
                    lives--;
                    updateLives();
                    if (lives <= 0) {
                        gameOver(false);
                    } else {
                        // å«å£«é‡ç”Ÿ
                        document.getElementById('messageBox').textContent = 'âŒ ç³»ç»Ÿæ„ŸæŸ“ï¼Œå«å£«é‡ç”Ÿï¼';
                        resetPositions();
                    }
                }
            }
        });
    }

    /**
     * æ¸¸æˆä¸»å¾ªç¯
     */
    function gameLoop(timestamp) {
        if (!gameActive) return;

        if (lastTime === 0) lastTime = timestamp;
        const deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        // 1. æ¸…ç†ç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 2. çŠ¶æ€æ›´æ–°
        if (firewallActive) {
            firewallTimer -= deltaTime;
            if (firewallTimer <= 0) {
                firewallActive = false;
                ghosts.forEach(g => g.isFrightened = false);
                document.getElementById('messageBox').textContent = 'é˜²ç«å¢™å‡çº§ç»“æŸï¼Œå¨èƒæ¢å¤è­¦æƒ•ï¼';
            }
        }

        // 3. ç§»åŠ¨
        movePlayer();
        moveGhosts(); 

        // 4. ç¢°æ’æ£€æµ‹
        checkDotCollision();
        checkGhostCollision();

        // 5. æ¸²æŸ“
        drawMap();
        drawGhosts();
        drawPlayer();

        // 6. å¾ªç¯
        requestAnimationFrame(gameLoop);
    }

    /**
     * æ›´æ–°åˆ†æ•°æ˜¾ç¤º
     */
    function updateScore() {
        document.getElementById('scoreDisplay').textContent = score;
    }

    /**
     * æ›´æ–°ç”Ÿå‘½å€¼æ˜¾ç¤º
     */
    function updateLives() {
        document.getElementById('livesDisplay').textContent = lives;
    }

    // ==========================================================
    // UI æ›´æ–°ä¸æµç¨‹æ§åˆ¶
    // ==========================================================
    
    /**
     * è°ƒæ•´ç”»å¸ƒå°ºå¯¸ä»¥é€‚åº”å®¹å™¨
     */
    function resizeCanvas() {
        const container = document.querySelector('.canvas-container');
        const containerWidth = container.clientWidth;
        
        // åŸºäºå®¹å™¨å®½åº¦é‡æ–°è®¡ç®— TILE_SIZE
        TILE_SIZE = Math.floor(containerWidth / MAP_W);
        if (TILE_SIZE < 20) TILE_SIZE = 20; // æœ€å°å°ºå¯¸é™åˆ¶
        if (TILE_SIZE > 35) TILE_SIZE = 35; // æœ€å¤§å°ºå¯¸é™åˆ¶

        canvas.width = MAP_W * TILE_SIZE;
        canvas.height = MAP_H * TILE_SIZE;
        
        // æ›´æ–°è§’è‰²å°ºå¯¸ (ç©å®¶å’Œå¹½çµå°ºå¯¸çš„ç™¾åˆ†æ¯”)
        player.radius = TILE_SIZE * 0.48; 
        ghosts.forEach(g => g.size = TILE_SIZE * 0.8);

        // å¦‚æœæ¸¸æˆæœªå¼€å§‹ï¼Œåˆ™é‡æ–°ç»˜åˆ¶åœ°å›¾å¹¶æ›´æ–°åˆå§‹ä½ç½®
        if (!gameActive) {
            drawMap();
            resetPositions(); 
        }
    }


    /**
     * é”®ç›˜äº‹ä»¶å¤„ç†
     */
    function handleKeyDown(e) {
        if (!gameActive && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
            startGame();
            return;
        }
        if (!gameActive) return;

        // è®¾ç½®ç›®æ ‡æ–¹å‘ï¼Œå¹¶é˜»æ­¢é»˜è®¤æ»šåŠ¨è¡Œä¸º
        switch (e.key) {
            case 'ArrowUp': e.preventDefault(); player.targetDirY = -1; player.targetDirX = 0; break;
            case 'ArrowDown': e.preventDefault(); player.targetDirY = 1; player.targetDirX = 0; break;
            case 'ArrowLeft': e.preventDefault(); player.targetDirX = -1; player.targetDirY = 0; break;
            case 'ArrowRight': e.preventDefault(); player.targetDirX = 1; player.targetDirY = 0; break;
        }
    }
    
    /**
     * è§¦æ‘¸æ§åˆ¶äº‹ä»¶å¤„ç†
     */
    function setupTouchControls() {
        const controls = document.getElementById('touchControls');
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        if (isTouchDevice) {
            controls.classList.remove('hidden');
            
            const handleDirection = (dirX, dirY) => {
                if (!gameActive) startGame();
                player.targetDirX = dirX;
                player.targetDirY = dirY;
            };

            document.getElementById('upBtn').ontouchstart = () => handleDirection(0, -1);
            document.getElementById('downBtn').ontouchstart = () => handleDirection(0, 1);
            document.getElementById('leftBtn').ontouchstart = () => handleDirection(-1, 0);
            document.getElementById('rightBtn').ontouchstart = () => handleDirection(1, 0);
        }
    }


    /**
     * åˆå§‹åŒ–æ¸¸æˆ
     */
    function initGame() {
        // è®¡ç®—æ€»ä»£ç ç‚¹æ•°
        totalDots = INITIAL_MAP_LAYOUT.flat().filter(tile => tile === 0 || tile === 3).length;
        
        // ç»‘å®šäº‹ä»¶
        window.addEventListener('keydown', handleKeyDown);
        document.getElementById('startButton').onclick = startGame;
        window.addEventListener('resize', resizeCanvas);
        
        setupTouchControls();
        resizeCanvas(); // é¦–æ¬¡è¿è¡Œæ—¶è°ƒæ•´å¤§å°
        
        // åˆå§‹æ¸²æŸ“
        drawMap();
    }
    
    /**
     * å¼€å§‹æ¸¸æˆ
     */
    function startGame() {
        if (gameActive) return;
        
        // ç¡®ä¿åœ°å›¾é‡ç½®
        MAP = INITIAL_MAP_LAYOUT.map(row => [...row]);
        
        // é‡ç½®çŠ¶æ€
        score = 0;
        lives = 3;
        dotsEaten = 0;
        firewallActive = false;
        firewallTimer = 0;
        
        resetPositions();
        updateScore();
        updateLives();
        document.getElementById('messageBox').innerHTML = '<p class="text-green-400">ç³»ç»Ÿå·²å¯åŠ¨ï¼å¼€å§‹ä¿å«ï¼</p>';
        
        // å¯åŠ¨ä¸»å¾ªç¯
        gameActive = true;
        lastTime = 0;
        requestAnimationFrame(gameLoop);
    }

    /**
     * æ¸¸æˆç»“æŸ
     */
    function gameOver(win) {
        gameActive = false;
        
        const messageTitle = win ? 'âœ… ä»»åŠ¡å®Œæˆï¼' : 'âŒ ç³»ç»Ÿå´©æºƒï¼';
        const messageContent = win ? 'æ‚¨æˆåŠŸæ¸…ç†äº†æ‰€æœ‰ä»£ç ï¼' : 'æ¶æ„è½¯ä»¶å·²å®Œå…¨æ„ŸæŸ“ç³»ç»Ÿï¼';
        
        const resultModal = document.getElementById('messageBox');
        resultModal.innerHTML = `
            <p class="text-xl font-bold mb-2 ${win ? 'text-green-400' : 'text-red-400'}">${messageTitle}</p>
            <p class="text-lg text-white">${messageContent} æœ€ç»ˆå¾—åˆ†: <span class="text-yellow-300">${score}</span></p>
            <button class="px-3 py-1 mt-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600" onclick="startGame()">
                é‡æ–°å¯åŠ¨ç³»ç»Ÿ (å†æ¥ä¸€æ¬¡)
            </button>
        `;
    }

    // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨
    window.onload = initGame;
</script>

</body>
</html>
